import time
import random
import sys

def read_input_file(file_path):
    """Read and parse the input file"""
    paintings = []
    
    try:
        with open(file_path, 'r') as file:
            # Read number of paintings
            n = int(file.readline().strip())
            
            # Read each painting
            for i in range(n):
                line = file.readline().strip().split()
                if not line:
                    continue
                    
                orientation = line[0]
                num_tags = int(line[1])
                tags = line[2:2+num_tags]
                
                paintings.append({
                    'id': i,
                    'orientation': orientation,
                    'tags': set(tags)
                })
                
        return paintings
    
    except FileNotFoundError:
        print(f"Error: File '{file_path}' not found.")
        return None
    except Exception as e:
        print(f"Error reading file: {e}")
        return None

def create_frameglasses(paintings):
    """Create frameglasses from paintings"""
    landscapes = [p for p in paintings if p['orientation'] == 'L']
    portraits = [p for p in paintings if p['orientation'] == 'P']
    
    frameglasses = []
    
    # Create frameglasses for landscapes (one painting each)
    for landscape in landscapes:
        frameglasses.append({
            'type': 'landscape',
            'paintings': [landscape['id']],
            'tags': landscape['tags']
        })
    
    # Create frameglasses for portraits (two paintings each)
    for i in range(0, len(portraits) - 1, 2):
        portrait1 = portraits[i]
        portrait2 = portraits[i + 1]
        
        combined_tags = portrait1['tags'] | portrait2['tags']
        
        frameglasses.append({
            'type': 'portrait',
            'paintings': [portrait1['id'], portrait2['id']],
            'tags': combined_tags
        })
    
    return frameglasses

def order_same(frameglasses):
    """Order frameglasses in the same order as created"""
    return frameglasses.copy()

def order_reverse(frameglasses):
    """Order frameglasses in reverse order"""
    return frameglasses[::-1]

def order_random(frameglasses):
    """Order frameglasses randomly"""
    shuffled = frameglasses.copy()
    random.shuffle(shuffled)
    return shuffled

def order_by_tag_count(frameglasses):
    """Order frameglasses by number of tags (ascending)"""
    return sorted(frameglasses, key=lambda x: len(x['tags']))

def calculate_satisfaction(frameglasses_order):
    """Calculate the global robotic satisfaction score"""
    if len(frameglasses_order) < 2:
        return 0
    
    total_score = 0
    
    for i in range(len(frameglasses_order) - 1):
        tags1 = frameglasses_order[i]['tags']
        tags2 = frameglasses_order[i + 1]['tags']
        
        common = len(tags1 & tags2)
        only1 = len(tags1 - tags2)
        only2 = len(tags2 - tags1)
        
        local_score = min(common, only1, only2)
        total_score += local_score
    
    return total_score

def write_output_file(frameglasses, output_path):
    """Write the output file in required format"""
    try:
        with open(output_path, 'w') as file:
            # Write number of frameglasses
            file.write(f"{len(frameglasses)}\n")
            
            # Write each frameglass
            for fg in frameglasses:
                if fg['type'] == 'landscape':
                    file.write(f"{fg['paintings'][0]}\n")
                else:  # portrait
                    file.write(f"{fg['paintings'][0]} {fg['paintings'][1]}\n")
        
        print(f"Output written to: {output_path}")
        return True
    
    except Exception as e:
        print(f"Error writing output file: {e}")
        return False

def evaluate_strategy(strategy_name, frameglasses, strategy_func):
    """Evaluate a single strategy and return results"""
    start_time = time.time()
    
    # Apply ordering strategy
    ordered_frameglasses = strategy_func(frameglasses)
    
    # Calculate score
    score = calculate_satisfaction(ordered_frameglasses)
    
    end_time = time.time()
    execution_time = end_time - start_time
    
    return {
        'name': strategy_name,
        'ordered_frameglasses': ordered_frameglasses,
        'score': score,
        'time': execution_time
    }

def main():
    """Main function"""
    print("=== HCW Painting Ordering System ===")
    print("Task: Implement basic ordering strategies\n")
    
    # Get input file path from user
    file_path = input("Enter the path to the input file: ").strip()
    
    # Read and parse input file
    print(f"\nReading input file: {file_path}")
    paintings = read_input_file(file_path)
    
    if paintings is None:
        print("Failed to read input file. Exiting.")
        return
    
    print(f"Successfully read {len(paintings)} paintings")
    
    # Count painting types
    landscapes = sum(1 for p in paintings if p['orientation'] == 'L')
    portraits = sum(1 for p in paintings if p['orientation'] == 'P')
    print(f"Landscapes: {landscapes}, Portraits: {portraits}")
    
    # Create frameglasses
    print("\nCreating frameglasses...")
    frameglasses = create_frameglasses(paintings)
    print(f"Created {len(frameglasses)} frameglasses")
    
    # Define strategies to evaluate
    strategies = [
        ("Same order", order_same),
        ("Reverse order", order_reverse),
        ("Random order", order_random),
        ("Order by tag count", order_by_tag_count)
    ]
    
    # Evaluate all strategies
    print("\nEvaluating ordering strategies...")
    results = []
    
    for strategy_name, strategy_func in strategies:
        result = evaluate_strategy(strategy_name, frameglasses, strategy_func)
        results.append(result)
        print(f"{strategy_name}: Score = {result['score']}, Time = {result['time']:.4f}s")
    
    # Find best strategy
    best_result = max(results, key=lambda x: x['score'])
    print(f"\nBest strategy: {best_result['name']} with score {best_result['score']}")
    
    # Write output file for best strategy
    output_path = file_path.replace('.txt', '_output.txt')
    if write_output_file(best_result['ordered_frameglasses'], output_path):
        print(f"Best ordering written to: {output_path}")
    
    # Display some statistics
    print(f"\n=== Execution Summary ===")
    print(f"Total paintings processed: {len(paintings)}")
    print(f"Frameglasses created: {len(frameglasses)}")
    print(f"Strategies evaluated: {len(strategies)}")
    
    # Show detailed results
    print(f"\n=== Detailed Results ===")
    for result in results:
        print(f"{result['name']:20} | Score: {result['score']:4d} | Time: {result['time']:.4f}s")

if __name__ == "__main__":
    main()
